---
title: "Inquiline Genomics: analysis and summary of CAFE gene families"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 2
    collapsed: true
    number_sections: true
    df_print: paged
  pdf_document: default
---
<STYLE TYPE="text/css">
<!--
  td{
    font-family: Arial; 
    font-size: 8pt;
    padding:0px;
    cellpadding="0";
    cellspacing="0"
  }
  th {
    font-family: Arial; 
    font-size: 8pt;
    height: 20px;
    font-weight: bold;
    text-align: right;
    background-color: #ccccff;
  }
  table { 
    border-spacing: 0px;
    border-collapse: collapse;
  }
--->
</STYLE>


# Bash steps: prepare GO annotations and input files
```{bash eval=FALSE, include=FALSE}
cd /Users/lukas/sciebo/inquilineGenomics18/GOenrichment/data/
cp /Users/lukas/CSE/attine_genomes/reannotations_of_7_ants/*/annotation/function_annotation/*.GO .
cp /Users/lukas/sciebo/inquilineGenomics18/inquilines_v2.1/*/annotation/function_annotation/*.GO .
cp /Users/lukas/sciebo/inquilineGenomics18/geneFamilies/MCLclustering/Acro+Acol/mcl/seq.af50lf25.mci.I01.5 .
cp /Users/lukas/sciebo/inquilineGenomics18/geneFamilies/MCLclustering/Acro+Acol/mcl.clean/largeQC.TEpso.nofilter.MCL.I01.5.cafe.filter100.tsv .
cp /Users/lukas/sciebo/inquilineGenomics18/geneFamilies/CAFE/results/Acro.Atta/RUN4C/RUN4C/m6b.cafe .


```

```{bash eval=FALSE, include=FALSE}
cd /Users/lukas/sciebo/inquilineGenomics18/GOenrichment/data/

for i in $(ls /Users/lukas/sciebo/inquilineGenomics18/GOenrichment/data/)
do
  species=$(echo $i|cut -f 1 -d ".")
  #perl /Users/lukas/sciebo/inquilineGenomics18/code/GOenrichment/GOannotation2topGO.pl  $i > gene2GO.$species.tsv
done

#cat gene2GO.*.tsv > all.gene2GO.tsv

```

# R steps
## Load environment
```{r message=FALSE, warning=FALSE, paged.print=FALSE}

#source("https://bioconductor.org/biocLite.R")
#biocLite("GO.db")
#library("topGO")
library(dplyr)
library(plyr)
library(tidyr)
```
### Load mcl cluster file and cluster QC file
```{r}

clustersFile <- list.files(path="/Users/lukas/sciebo/inquilineGenomics18/GOenrichment/data/", pattern=".mci.", all.files=T, full.names=T)
c<-read.csv(clustersFile,sep="\t",F)
clusterQCFile <- "/Users/lukas/sciebo/inquilineGenomics18/geneFamilies/MCLclustering/Acro+Acol/mcl.clean/finalQC.I01.5.tsv"
cQC<-read.csv(clusterQCFile,sep="\t",T)

```

### Run sanity check that cluster QC and cluster files match.

Generate large file combining cluster memberships (from mcl) and cluster qc
```{r}
#sanity checks
head(c[1000,1:10])
subset(cQC,ClusterID=="Cluster1000")
c2<-unite(c,"all",sep=" ")
c3<-cbind(c$V1,c2)
colnames(c3)[1]<-c("ClusterRef")
m<-merge(cQC,c3,by="ClusterRef",all.x=T)
m$all<-gsub(x=m$all,"  ","")
```

### Load GO annotations
```{r}
# load GO annotations
goFiles<-list.files(path="/Users/lukas/sciebo/inquilineGenomics18/GOenrichment/data/", pattern="^gene2GO.*tsv$", all.files=T, full.names=T)

goAnns<-list()
i<-1
for (i in 1:length(goFiles)){
  goAnns[[i]]<-read.csv(goFiles[i], sep="\t",F)
}

names(goAnns)<-gsub(x=goFiles,pattern=".*\\.(.*).tsv","\\1",perl=T)
rGoAnns<-do.call(rbind, goAnns)

# read in list of GO terms in topGO object:
######################################################
geneID2GO<-readMappings("/Users/lukas/sciebo/inquilineGenomics18/GOenrichment/data/all.gene2GO.tsv")


```

### Add cluster GO annotations to large data frame (m)
```{r}
ms<-strsplit(m$all," ",)

m$uniqueGOs<-NA
for (i in 1:length(ms)){
  geneSearch<-paste(ms[[i]],collapse="|")
  matchingCol<-grep(pattern=geneSearch,rGoAnns$V1,perl=T)
  uniqueGOs<-unique(rGoAnns$V2[matchingCol])
  m$uniqueGOs[i]<-paste(uniqueGOs,collapse = ",")
}

```

### Load Cafe results file and split pvalues
```{r}

cafeResultsFile<-"/Users/lukas/sciebo/inquilineGenomics18/GOenrichment/data/m6b.cafe"
cafe<-read.csv(cafeResultsFile,sep="\t",skip=10)

sp<-strsplit(as.character(cafe$X.Viterbi.P.values.),',') %>% do.call(rbind, .) %>% gsub("\\(|\\)","",.,perl=T) 
sp[sp=="-"]<-NA
sp<-data.frame(sp)
for(i in 1:dim(sp)[2]){
  sp[,i]<-as.numeric(as.character(sp[,i]))
}


pvalOrder<-c(c(0,3),c(2,4),c(1,7),c(6,8),c(5,10) )

nodeIds <- data.frame('node' = c("AHEYp","ACHAp","PARGp","ACHA.PARGp","AHEY.ACHA.PARGp","AECHp","AINSp","AECH.AINSp","ACROp","ACOLp","ROOTp"), 
                   'id' = c(0,2,4,3,1,6,8,7,5,10,9))

nodeIds<-nodeIds[match(pvalOrder, nodeIds$id),]
colnames(sp)<-nodeIds$node

cafe2<-cbind(cafe,sp)
all<-merge(m,cafe2,by.x="ClusterID",by.y="X.ID.",all.x=T)

```

### Split Newick tree generated by CAFE
```{r}
tmp2<-list()
for (i in 1:length(all$X.Newick.)){
  if (is.na(all$X.Newick.[i])){
    tmp2[[i]]<-rep(NA,11)
  }else{
  tmp<-sapply(strsplit(as.character(all$X.Newick.), "\\_"), "[")[[i]]
  tmp2[[i]]<-as.numeric(gsub(x=tmp,pattern="\\:.*","",perl=T)[-1])
  }
}
newick<-data.frame(do.call(rbind,tmp2))
colnames(newick)<-c("AHEYc","ACHAc","PARGc","ACHA.PARGc","AHEY.ACHA.PARGc","AECHc","AINSc","AECH.AINSc","ACROc","ACOLc","LCc")
all<-cbind(all,newick)
sum(all$AECHc!=all$AECH,na.rm=T)
```

### Save giant dataframe to /Users/lukas/sciebo/inquilineGenomics18/GOenrichment/data.tsv
```{r}
write.table(all,"/Users/lukas/sciebo/inquilineGenomics18/geneFamilies/CAFE/results/Acro.Atta/bestModel.m6b.RUN4c.tsv",sep="\t",quote=F,row.names = F)
```
